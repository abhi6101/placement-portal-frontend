<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hack-2-Hired</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="jobs.css">

</head>

<body>
     <nav>
        <div class="logo">Placement<span>Portal</span></div>
       
    </nav>

    <nav class="main-nav">
        <ul>
            <li><a href="index.html"><i class="fas fa-home"></i> Home</a></li>
          <li><a href="jobs.html" class="active"><i class="fas fa-briefcase"></i> Jobs</a></li>
          <li><a href="resume.html"><i class="fas fa-file-alt"></i> Resume Builder</a></li>
          <li><a href="interview.html"><i class="fas fa-comments"></i> Interviews</a></li>
           <li><a href="papers.html"><i class="fas fa-scroll"></i> Previous Papers</a></li>
            <li><a href="quiz.html"><i class="fas fa-brain"></i> Quiz</a></li>
             <li><a href="gallery.html"><i class="fas fa-images"></i> Gallery</a></li>
          <li><a href="videos.html"><i class="fas fa-video"></i> Study Videos</a></li>
          <li><a href="courses.html"  ><i class="fas fa-book"></i> Courses</a></li>
          <li><a href="blog.html" ><i class="fas fa-blog"></i> Blog</a></li>
          <li><a href="contact.html"><i class="fas fa-envelope"></i> Contact</a></li>
        </ul>
    </nav>

    <div class="container">
        <div class="page-header">
            <h1>Job Opportunities</h1>
            <p>Browse through our latest job openings from top companies and kickstart your career</p>
        </div>

        <div class="search-container">
            <form class="search-form" id="searchForm">
                <input type="text" class="search-input" id="searchInput" placeholder="Job title, keywords, or company">
                <input type="text" class="search-input" id="locationInput" placeholder="Location">
                <button type="submit" class="btn search-btn">
                    <i class="fas fa-search"></i> Search Jobs
                </button>
            </form>
        </div>

        <div class="filter-section">
            <div class="filter-buttons">
                <button class="filter-btn active" data-filter="all">All Jobs</button>
                <button class="filter-btn" data-filter="it">IT/Software</button>
                <button class="filter-btn" data-filter="engineering">Engineering</button>
                <button class="filter-btn" data-filter="finance">Finance</button>
                <button class="filter-btn" data-filter="internship">Internships</button>
            </div>
            <div class="sort-options">
                <label for="sortSelect">Sort by:</label>
                <select id="sortSelect">
                    <option value="newest">Newest First</option>
                    <option value="salary-high">Salary (High to Low)</option>
                    <option value="salary-low">Salary (Low to High)</option>
                    <option value="deadline">Application Deadline</option>
                </select>
            </div>
        </div>

        <div class="job-list" id="jobList">
            <div class="loading">
                <i class="fas fa-spinner"></i> Loading jobs...
            </div>
        </div>

        <div class="pagination">
            <button class="page-btn"><i class="fas fa-chevron-left"></i></button>
            <button class="page-btn active">1</button>
            <button class="page-btn">2</button>
            <button class="page-btn">3</button>
            <button class="page-btn"><i class="fas fa-chevron-right"></i></button>
        </div>
    </div>


    <div id="applicationFormModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>Apply for <span id="jobTitleForApplication"></span></h2>
            <form id="jobApplicationForm" enctype="multipart/form-data">
                <input type="hidden" id="appliedJobId" name="jobId">

                <div class="form-group">
                    <label for="applicantName">Full Name:</label>
                    <input type="text" id="applicantName" name="applicantName" required>
                </div>

                <div class="form-group">
                    <label for="applicantEmail">Email:</label>
                    <input type="email" id="applicantEmail" name="applicantEmail" required>
                </div>

                <div class="form-group">
                    <label for="applicantPhone">Phone Number:</label>
                    <input type="tel" id="applicantPhone" name="applicantPhone" required>
                </div>

                <div class="form-group">
                    <label for="applicantRollNo">Roll Number (if applicable):</label>
                    <input type="text" id="applicantRollNo" name="applicantRollNo">
                </div>

                <div class="form-group">
                    <label for="resume">Upload Resume (PDF only):</label>
                    <input type="file" id="resume" name="resume" accept=".pdf" required>
                </div>

                <div class="form-group">
                    <label for="coverLetter">Cover Letter (Optional):</label>
                    <textarea id="coverLetter" name="coverLetter" rows="5"></textarea>
                </div>

                <button type="submit" class="btn">Submit Application</button>
            </form>
        </div>
    </div>


    <footer>
         <p>Made with <span class="heart">❤️</span> by Abhi</p>
       
        <p>&copy; 2025 College Placement System. All rights reserved. | Contact: <a
                href="mailto:hack2hired.official@gmail.com">hack2hired.official@gmail.com</a></p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
    // --- 1. Constants and Element Caching ---
    const API_URL = "https://placement-portal-backend-nwaj.onrender.com/api/jobs";
    const APPLY_JOB_API_URL = "https://placement-portal-backend-nwaj.onrender.com/api/apply-job";
    
    const jobList = document.getElementById('jobList');
    const searchInput = document.getElementById('searchInput');
    const filterButtons = document.querySelectorAll('.filter-btn');
    const sortSelect = document.getElementById('sortSelect');
    
    const applicationFormModal = document.getElementById('applicationFormModal');
    const closeModalButton = document.querySelector('.close-button');
    const jobApplicationForm = document.getElementById('jobApplicationForm');
    const jobTitleForApplication = document.getElementById('jobTitleForApplication');
    const appliedJobIdInput = document.getElementById('appliedJobId');

    let allJobs = [];
    let currentUserDetails = null;

    // --- 2. Helper Functions ---
    const getUserDetailsFromToken = (token) => {
        try {
            const payload = JSON.parse(atob(token.split('.')[1]));
            return { username: payload.sub, email: payload.email || '', exp: payload.exp };
        } catch (e) { return null; }
    };
    const formatDate = (dateString) => new Date(dateString).toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });

    // --- 3. Authentication ---
    const handleAuth = () => {
        const token = localStorage.getItem("authToken");
        if (!token) { window.location.href = "login.html"; return { token: null, isValid: false }; }
        currentUserDetails = getUserDetailsFromToken(token);
        if (!currentUserDetails || currentUserDetails.exp < Date.now() / 1000) {
            localStorage.clear(); alert("Your session has expired. Please log in again.");
            window.location.href = "login.html"; return { token: null, isValid: false };
        }
        return { token, isValid: true };
    };

    const auth = handleAuth();
    if (!auth.isValid) {
        if(jobList) jobList.innerHTML = `<div class="loading-indicator"><span>Please <a href="login.html">log in</a> to view job opportunities.</span></div>`;
        return;
    }

    // --- 4. Main Application Logic ---
    function initializePage(token) {
        const loadJobs = async () => {
            if(!jobList) return;
            jobList.innerHTML = '<div class="loading-indicator"><div class="spinner"></div><span>Loading Jobs...</span></div>';
            try {
                const response = await fetch(API_URL, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                allJobs = await response.json();
                filterAndSortJobs();
            } catch (error) {
                jobList.innerHTML = `<div class="loading-indicator"><span>Failed to load jobs. Please refresh.</span></div>`;
            }
        };

        const displayJobs = (jobs) => {
            if(!jobList) return;
            jobList.innerHTML = '';
            if (jobs.length === 0) {
                jobList.innerHTML = `<div class="loading-indicator"><span>No jobs found matching your criteria.</span></div>`;
                return;
            }
            jobs.forEach((job, index) => {
                const jobCard = document.createElement('div');
                jobCard.className = 'job-card surface-glow';
                jobCard.style.animationDelay = `${index * 0.05}s`;
                const jobTypeClass = job.title.toLowerCase().includes('intern') ? 'internship' : '';
                const jobTypeText = job.title.toLowerCase().includes('intern') ? 'Internship' : 'Full-time';
                jobCard.innerHTML = `
                    <div class="job-header"><h3 class="job-title">${job.title}</h3><div class="job-company"><i class="fas fa-building"></i> ${job.company_name}</div><span class="job-type ${jobTypeClass}">${jobTypeText}</span></div>
                    <p class="job-description">${job.description.substring(0, 150)}...</p>
                    <div class="job-meta"><span><i class="fas fa-rupee-sign"></i> ₹${job.salary.toLocaleString('en-IN')} / Annum</span><span><i class="fas fa-calendar-times"></i> Deadline: ${formatDate(job.last_date)}</span></div>
                    <div class="job-actions">
                        <a href="job-details.html?id=${job.id}" class="btn btn-outline"><i class="fas fa-eye"></i> View Details</a>
                        <button class="btn btn-primary apply-btn" data-job-id="${job.id}" data-job-title="${job.title}">Apply Now</button>
                    </div>
                `;
                jobList.appendChild(jobCard);
            });
        };
        
        const filterAndSortJobs = () => {
            const searchTerm = searchInput.value.toLowerCase();
            const activeFilter = document.querySelector('.filter-btn.active').dataset.filter;
            let filteredJobs = allJobs.filter(job => {
                const matchesSearch = job.title.toLowerCase().includes(searchTerm) || job.company_name.toLowerCase().includes(searchTerm);
                let matchesFilter = (activeFilter === 'all') || (job.title.toLowerCase().includes(activeFilter) || job.description.toLowerCase().includes(activeFilter));
                return matchesSearch && matchesFilter;
            });
            const sortValue = sortSelect.value;
            filteredJobs.sort((a, b) => {
                switch (sortValue) {
                    case 'salary-high': return b.salary - a.salary;
                    case 'deadline': return new Date(a.last_date) - new Date(b.last_date);
                    default: return new Date(b.created_at || b.last_date) - new Date(a.created_at || b.last_date);
                }
            });
            displayJobs(filteredJobs);
        };

        const openModal = (jobId, jobTitle) => {
            jobTitleForApplication.textContent = jobTitle;
            appliedJobIdInput.value = jobId;
            document.getElementById('applicantName').value = currentUserDetails.username || '';
            document.getElementById('applicantEmail').value = currentUserDetails.email || '';
            applicationFormModal.classList.add('show');
        };
        const closeModal = () => {
            applicationFormModal.classList.remove('show');
            jobApplicationForm.reset();
        };

        // --- Event Listeners Setup ---
        searchInput.addEventListener('input', filterAndSortJobs);
        sortSelect.addEventListener('change', filterAndSortJobs);
        filterButtons.forEach(button => {
            button.addEventListener('click', function () {
                filterButtons.forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                filterAndSortJobs();
            });
        });
        jobList.addEventListener('click', e => {
            const applyButton = e.target.closest('.apply-btn');
            if (applyButton) {
                openModal(applyButton.dataset.jobId, applyButton.dataset.jobTitle);
            }
        });
        closeModalButton.addEventListener('click', closeModal);
        applicationFormModal.addEventListener('click', e => { if (e.target === applicationFormModal) closeModal(); });

        // --- THE DEFINITIVE FIX FOR THE SUBMISSION ---
        jobApplicationForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const submitButton = this.querySelector('button[type="submit"]');
            const submitButtonText = submitButton.innerHTML;
            
            submitButton.disabled = true;
            submitButton.innerHTML = `<span class="spinner"></span> Submitting...`;

            // Create FormData object directly from the form element
            const formData = new FormData(this);
            const jobId = formData.get('jobId');

            // Find the full job object to append details
            const job = allJobs.find(j => String(j.id) === jobId);
            if (job) {
                formData.append('jobTitle', job.title);
                formData.append('companyName', job.company_name);
            } else {
                alert('Error: Could not associate application with a job. Please try again.');
                submitButton.disabled = false;
                submitButton.innerHTML = submitButtonText;
                return;
            }

            try {
                const response = await fetch(APPLY_JOB_API_URL, {
                    method: 'POST',
                    headers: {
                        // DO NOT set Content-Type, browser does it automatically for FormData
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                
                if (response.ok) {
                    alert('Application submitted successfully!');
                    closeModal();
                    // Optionally disable the button on the main page
                    const originalApplyButton = document.querySelector(`.apply-btn[data-job-id="${jobId}"]`);
                    if (originalApplyButton) {
                        originalApplyButton.textContent = 'Applied';
                        originalApplyButton.disabled = true;
                    }
                } else {
                    const errorData = await response.json().catch(() => ({ message: 'An unknown server error occurred.' }));
                    alert(`Submission failed: ${errorData.message}`);
                }
            } catch (error) {
                console.error('Submission fetch error:', error);
                alert('An error occurred. Please check your network connection and try again.');
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = submitButtonText;
            }
        });
        
        // --- Initial Load ---
        loadJobs();
    }
    
    // --- SCRIPT ENTRY POINT ---
    const { token, isValid } = handleAuth();
    if (isValid) {
        initializePage(token);
    }
});
    </script>

</body>

</html>


